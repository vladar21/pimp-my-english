<!-- quizzes/templates/quizzes/quiz_settings.html -->
{% extends 'base.html' %}
{% load dict_filter %}

{% block title %}Quiz Settings - Pimp My English{% endblock %}

{% block content %}
<div class="winners-results fit-content">
    <div class="close-button-div">
        <button id="closeButtonSettings" class="close-button">x</button>
    </div>
    <form id="settings-form" method="post" action="{% url 'submit_quiz_settings' %}">
        {% csrf_token %}
        <table id="settings-table" class="winners-table">
            <caption>Settings</caption>
            <thead>
                <tr>
                    <th>pp</th>
                    <th>Describe</th>
                    <th>Name</th>
                    <th>Values</th>
                </tr>
            </thead>
            <tbody>
                <tr class="highlight">
                    <td>1</td>
                    <td>Total number of words for quiz</td>
                    <td>Total Words</td>
                    <td>
                        <label for="word-count-slider"><span id="word-count-label">{{ word_count }}</span> words</label>
                        <input type="range" id="word-count-slider" name="word_count" min="3" max="{{ word_count }}" value="{{ word_count }}">
                    </td>
                </tr>
                <tr class="highlight">
                    <td>2</td>
                    <td>CEFR levels of words for quiz ('A1', 'B1', 'B2' etc.)</td>
                    <td>CEFR Levels</td>
                    <td>
                        <div id="cefr-level-selection">
                            {% for level in cefr_levels %}
                                <label>
                                    <input id="cefr-checkbox-{{ level }}" type="checkbox" name="cefr_levels" value="{{ level }}"
                                           data-count="{{ cefr_counts|dict:level }}" 
                                           {% if cefr_counts|dict:level > 0 and level in selected_cefr_levels %}checked{% endif %}
                                           {% if cefr_total_counts|dict:level == 0 %}disabled{% endif %}>
                                    {{ level }} (<span id="cefr-level-count-{{ level }}">{{ cefr_counts|dict:level }} / {{ cefr_total_counts|dict:level }}</span> words)
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                <tr class="highlight">
                    <td>3</td>
                    <td>Types of words for quiz ('noun', 'adjective' etc.)</td>
                    <td>Word Types</td>
                    <td>
                        <div id="wordtype-level-selection">
                            {% for word_type in word_types %}
                                <label>
                                    <input id="words-types-checkbox-{{ word_type }}" type="checkbox" name="word_types" value="{{ word_type }}"
                                           data-count="{{ word_type_counts|dict:word_type }}" 
                                           {% if word_type_counts|dict:word_type > 0 and word_type in selected_word_types %}checked{% endif %}
                                           {% if word_type_total_counts|dict:word_type == 0 %}disabled{% endif %}>
                                    {{ word_type }} (<span id="words-types-count-{{ word_type }}">{{ word_type_counts|dict:word_type }} / {{ word_type_total_counts|dict:word_type }}</span> words)
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                <input id="flag_all_null" type="hidden" value="{{ flag_all_null }}">
                <tr class="highlight total">
                    <td colspan="4" class="reset-settings-default">
                        <button id="resetSettingsDefault" type="button">Reset</button>
                        <button id="saveSettingsDefault" type="submit">Save</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const closeButtonSettings = document.getElementById('closeButtonSettings');
        if (closeButtonSettings) {
            closeButtonSettings.addEventListener('click', () => {
                window.location.href = '/'; // Redirect to home page or another page
            });
        }

        const wordCountSlider = document.getElementById("word-count-slider");
        const wordCountLabel = document.getElementById("word-count-label");

        if (wordCountSlider && wordCountLabel) {
            wordCountSlider.addEventListener("input", function() {
                wordCountLabel.textContent = wordCountSlider.value;
            });
        }

        const flagAllNullField = document.getElementById("flag_all_null");

        const sendUpdate = (settingName, settingData) => {
            let flag_all_null = flagAllNullField.value;

            const updateData = {
                cefr_levels: settingName === 'cefr_levels' ? settingData : [],
                word_types: settingName === 'word_types' ? settingData : [],
                flag_all_null: flag_all_null
            };

            fetch("{% url 'update_quiz_settings' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("word-count-label").textContent = data.word_count;
                wordCountSlider.max = data.word_count;
                flagAllNullField.value = data.flag_all_null;

                Object.entries(data.cefr_counts).forEach(([level, count]) => {
                    const span = document.getElementById(`cefr-level-count-${level}`);
                    if (span) {
                        span.textContent = `${count} / ${data.cefr_total_counts[level]}`;
                    }
                    const checkbox = document.getElementById(`cefr-checkbox-${level}`);
                    if (checkbox) {
                        checkbox.checked = count > 0;
                        checkbox.disabled = data.cefr_total_counts[level] === 0;
                    }
                });

                Object.entries(data.word_type_counts).forEach(([wordType, count]) => {
                    const span = document.getElementById(`words-types-count-${wordType}`);
                    if (span) {
                        span.textContent = `${count} / ${data.word_type_total_counts[wordType]}`;
                    }
                    const checkbox = document.getElementById(`words-types-checkbox-${wordType}`);
                    if (checkbox) {
                        checkbox.checked = count > 0;
                        checkbox.disabled = data.word_type_total_counts[wordType] === 0;
                    }
                });
            });
        };

        const updateCefrLevels = () => {
            const checkedCefrLevels = Array.from(document.querySelectorAll('input[name="cefr_levels"]:checked')).map(checkbox => checkbox.value);
            if (checkedCefrLevels.length === 0) {
                flagAllNullField.value = 'true';
            } else {
                flagAllNullField.value = 'false';
            }
            sendUpdate('cefr_levels', checkedCefrLevels);
        };

        const updateWordTypes = () => {
            const checkedWordTypes = Array.from(document.querySelectorAll('input[name="word_types"]:checked')).map(checkbox => checkbox.value);
            if (checkedWordTypes.length === 0) {
                flagAllNullField.value = 'true';
            } else {
                flagAllNullField.value = 'false';
            }
            sendUpdate('word_types', checkedWordTypes);
        };

        document.querySelectorAll('input[name="cefr_levels"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateCefrLevels);
        });

        document.querySelectorAll('input[name="word_types"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateWordTypes);
        });

        const resetButton = document.getElementById('resetSettingsDefault');
        if (resetButton) {
            resetButton.addEventListener('click', () => {
                fetch("{% url 'update_quiz_settings' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        setting_name: 'reset',
                        setting_data: [],
                        flag_all_null: 'false'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("word-count-label").textContent = data.word_count;
                    wordCountSlider.max = data.word_count;
                    wordCountSlider.value = data.word_count;

                    Object.entries(data.cefr_counts).forEach(([level, count]) => {
                        const span = document.getElementById(`cefr-level-count-${level}`);
                        if (span) {
                            span.textContent = `${count} / ${data.cefr_total_counts[level]}`;
                        }
                        const checkbox = document.getElementById(`cefr-checkbox-${level}`);
                        if (checkbox) {
                            checkbox.checked = count > 0;
                            checkbox.disabled = data.cefr_total_counts[level] === 0;
                        }
                    });

                    Object.entries(data.word_type_counts).forEach(([wordType, count]) => {
                        const span = document.getElementById(`words-types-count-${wordType}`);
                        if (span) {
                            span.textContent = `${count} / ${data.word_type_total_counts[wordType]}`;
                        }
                        const checkbox = document.getElementById(`words-types-checkbox-${wordType}`);
                        if (checkbox) {
                            checkbox.checked = count > 0;
                            checkbox.disabled = data.word_type_total_counts[wordType] === 0;
                        }
                    });

                    flagAllNullField.value = 'false';
                });
            });
        }
    });
</script>
{% endblock %}
