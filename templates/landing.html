<!-- static/templates/landing.html -->

{% extends 'base.html' %}

{% block title %}Landing Page - Pimp My English{% endblock %}

{% block content %}
<div class="quizsquare">
    <h1 id="english-words-quiz" class="quiz-title-css">English Words Quiz</h1>

    <div id="quiz-field" class="quiz-field-css">
        <div id="question-area">
            <h2 class="quiz-task">Guess the word by definition:</h2>
            <span class="word-type"></span>
            <span class="word-definition"></span>
        </div>

        <div class="content-task-container">
            <div class="word-image">
                <img class="img-word-image" src="#" alt="">
            </div>
            <div id="answer-list-area">
                <div class="answers-container">
                    <h3 id="choose-answer">it is ...</h3>
                    <ul class="answers-list">
                        <!-- Answer options will be added here dynamically -->
                    </ul>                
                </div>             
            </div>
        </div>
        
        <div class="control-buttons">
            <button id="stop-button">Stop</button>
            <div id="timer-spinner" class="timer-spinner">30</div>
            <button id="next-button">Next</button>
        </div>
        
        <div id="score-area" class="score-area">
            <div class="score-label">
                Answered/Total:
                <span id="answered-count" class="count">0</span>&nbsp;/&nbsp;
                <span id="total-count" class="count">0</span>
            </div>
            <div class="score-label">
                Right/Wrong:
                <span id="right-count" class="count right-count">0</span>&nbsp;/&nbsp;
                <span id="wrong-count" class="count wrong-count">0</span>
            </div>
        </div>
    </div>

    <div id="statistic-window">
        <div id="winner-quiz-field" class="winners-results">
            <table id="winners-table" class="winners-table">
                <caption>Winners Results</caption>
                <thead>
                   
                        <th>Place</th>
                        <th>Attempt</th>
                        <th>Scores</th>
                        <th>Time</th>
                
                </thead>
                <tbody>
                    <!-- Winners' results will be added here dynamically -->
                </tbody>
            </table>                
        </div>
    </div>

    <div id="rules-start-settings" class="rules-start-settings">
        <a href="{% url 'rules' %}" id="rules-link" class="rules-link">Rules</a>
        <select id="wordSetSelectLanding" class="word-set-select landing-select">
            <option value="0">Select Word Set</option>
        </select>
        <button id="start-quiz-button">Start</button>
        <a href="{% url 'quiz_settings' %}" id="settings-link" class="settings-link">Settings</a>
    </div>
</div>
<div id="hidden-filtered-words" data-words="{{ filtered_words|join:', ' }}" style="display: none;"></div>
<div id="hidden-unused-words" data-words="{{ unused_words|join:', ' }}" style="display: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const wordSetSelectLanding = document.getElementById('wordSetSelectLanding');
        const settingsLink = document.getElementById('settings-link');
        const hiddenFilteredWordsDiv = document.getElementById('hidden-filtered-words');
        const winnersTableBody = document.querySelector('#winners-table tbody');
        
        let currentQuiz = null;

        // Load word sets
        function loadWordSets() {
            showSpinner();
            fetch("{% url 'wordsets:list_word_sets' %}")
                .then(response => response.json())
                .then(data => {
                    data.word_sets.forEach(set => {
                        const option = document.createElement("option");
                        option.value = set.id;
                        option.textContent = set.name;
                        wordSetSelectLanding.appendChild(option);
                    });
                    hideSpinner();
                })
                .catch(error => {
                    console.error("Error loading word sets:", error)
                    hideSpinner();
                });
        }

        // Show spinner
        function showSpinner() {
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            document.body.appendChild(spinner);
            
            const startQuizButton = document.querySelector('#start-quiz-button');
            if (startQuizButton) {
                startQuizButton.disabled = true; // Disable the start button
            }
        }

        // Hide spinner
        function hideSpinner() {
            const spinner = document.querySelector('.spinner');
            if (spinner) {
                spinner.remove();
            }
            
            const startQuizButton = document.querySelector('#start-quiz-button');
            if (startQuizButton) {
                startQuizButton.disabled = false; // Enable the start button
            }
        }
        
        // Fetch filtered words based on selected word set
        function fetchFilteredWords(wordSetId) {            
            hiddenFilteredWordsDiv.dataset.words = '';
            showSpinner();
            
            let url = wordSetId ? `/wordsets/${wordSetId}/words/` : `/wordsets/0/words/`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    hiddenFilteredWordsDiv.dataset.words = data.words.join(', ');
                    initializeQuiz(data.words);
                    hideSpinner();
                })
                .catch(error => {
                    console.error("Error fetching filtered words:", error);
                    hideSpinner();
                });
        }


        // Initialize quiz
        function initializeQuiz(filteredWords) {
            if (currentQuiz) {
                currentQuiz.destroy();
            }
            currentQuiz = new Quiz(filteredWords);
        }

        // Event listener for changing the word set
        wordSetSelectLanding.addEventListener('change', function () {
            const selectedWordSetId = this.value;
            fetchFilteredWords(selectedWordSetId);
        });

        // Load word sets on page load
        loadWordSets();

        // Redirect to settings with selected word set
        settingsLink.addEventListener('click', (event) => {
            event.preventDefault();
            const selectedWordSetId = wordSetSelectLanding.value;
            const settingsUrl = selectedWordSetId ? `{% url 'quiz_settings' %}?word_set_id=${selectedWordSetId}` : "{% url 'quiz_settings' %}";
            window.location.href = settingsUrl;
        });

        // Initial call to set up the quiz with default word set
        const defaultWordSetId = wordSetSelectLanding.value;
        if (defaultWordSetId) {
            fetchFilteredWords(defaultWordSetId);
        }
    });
</script>

{% endblock %}
